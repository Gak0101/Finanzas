#:kivy 2.3.0
#:import FigureCanvasKivyAgg kivy_garden.matplotlib.backend_kivyagg.FigureCanvasKivyAgg
#:import MDLabel kivymd.uix.label.MDLabel
#:import MDButtonText kivymd.uix.button.MDButtonText
#:import MDButtonIcon kivymd.uix.button.MDButtonIcon
#:import MDIconButton kivymd.uix.button.MDIconButton
#:import MDTextField kivymd.uix.textfield.MDTextField
#:import MDTextFieldHintText kivymd.uix.textfield.MDTextFieldHintText
#:import MDTextFieldHelperText kivymd.uix.textfield.MDTextFieldHelperText
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import AnchorLayout kivy.uix.anchorlayout.AnchorLayout
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import Window kivy.core.window.Window
#:import Popup kivy.uix.popup.Popup

<FadeLabel@MDLabel>:
    opacity: 0
    canvas.before:
        Color:
            rgba: get_color_from_hex('#4CAF50') + [0.1]
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [5]

<CategoryRow@MDCard>:
    orientation: 'horizontal'
    size_hint_y: None
    height: "56dp"
    padding: "16dp"
    spacing: "16dp"
    md_bg_color: get_color_from_hex('#1E1E1E')
    radius: [8]
    ripple_behavior: True
    elevation: 2
    opacity: 0

    category_id: 0
    category_name: ""
    category_percentage: ""
    category_balance: ""

    canvas.before:
        Color:
            rgba: get_color_from_hex('#2A2A2A')
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [8]

    MDLabel:
        text: root.category_name
        size_hint_x: 0.4
        halign: 'left'
        theme_text_color: "Custom"
        text_color: get_color_from_hex('#FFFFFF')

    MDLabel:
        text: root.category_percentage
        size_hint_x: 0.2
        halign: 'center'
        theme_text_color: "Custom"
        text_color: get_color_from_hex('#4CAF50')

    MDLabel:
        text: root.category_balance
        size_hint_x: 0.2
        halign: 'right'
        theme_text_color: "Custom"
        text_color: get_color_from_hex('#4CAF50')

    MDBoxLayout:
        size_hint_x: None
        width: "100dp"
        adaptive_width: True
        spacing: "8dp"
        pos_hint: {'center_y': 0.5}

        MDIconButton:
            icon: "pencil"
            pos_hint: {'center_y': 0.5}
            theme_icon_color: "Custom"
            icon_color: get_color_from_hex('#FFFFFF')
            on_release: app.show_edit_category_popup(root.category_id)

        MDIconButton:
            icon: "trash-can"
            pos_hint: {'center_y': 0.5}
            theme_icon_color: "Custom"
            icon_color: get_color_from_hex('#FF5252')
            on_release: app.delete_category_action(root.category_id)

<FinanceRootWidget>:
    canvas.before:
        Color:
            rgba: get_color_from_hex('#121212')
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout: 
        orientation: 'vertical'
        spacing: "16dp"
        padding: "16dp"

        # --- Main Content Area --- #
        MDBoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.7 
            spacing: "16dp"

            # --- Left Side: Graph --- #
            MDCard: 
                id: graph_layout
                size_hint_x: 0.5
                elevation: 4
                radius: [12]
                md_bg_color: get_color_from_hex('#1E1E1E')
                ripple_behavior: True
                padding: "16dp"
                
                BoxLayout:
                    orientation: 'vertical'
                    
                    MDBoxLayout:
                        size_hint_y: None
                        height: "56dp"
                        padding: ["8dp", "0dp", "8dp", "0dp"]
                        md_bg_color: get_color_from_hex('#2A2A2A')
                        radius: [8]
                        
                        MDIcon:
                            icon: "chart-donut"
                            theme_text_color: "Custom"
                            text_color: get_color_from_hex('#4CAF50')
                            size_hint_x: None
                            width: "36dp"
                            
                        MDLabel: 
                            text: 'DASHBOARD FINANCIERO'
                            font_size: "24sp"
                            bold: True
                            theme_text_color: "Custom"
                            text_color: get_color_from_hex('#FFFFFF')
                            halign: 'center'
                    
                    Widget:
                        size_hint_y: 1
                        
                    # Botón invisible para actualizar el gráfico
                    Button:
                        size_hint: None, None
                        size: 0, 0
                        opacity: 0
                        on_release: app.update_graph()

            # --- Right Side: Categories --- #
            MDCard:
                orientation: 'vertical'
                size_hint_x: 0.5
                spacing: "8dp"
                elevation: 4
                radius: [12]
                md_bg_color: get_color_from_hex('#1E1E1E')
                padding: "16dp"

                MDBoxLayout:
                    size_hint_y: None
                    height: "56dp"
                    padding: ["8dp", "0dp", "8dp", "0dp"]
                    md_bg_color: get_color_from_hex('#2A2A2A')
                    radius: [8]
                    
                    MDIcon:
                        icon: "tag-multiple"
                        theme_text_color: "Custom"
                        text_color: get_color_from_hex('#4CAF50')
                        size_hint_x: None
                        width: "36dp"
                        
                    MDLabel: 
                        text: 'CATEGORÍAS DE GASTO'
                        font_size: "24sp"
                        bold: True
                        theme_text_color: "Custom"
                        text_color: get_color_from_hex('#FFFFFF')
                        halign: 'center'

                ScrollView: 
                    size_hint_y: 1
                    do_scroll_x: False
                    GridLayout: 
                        id: category_list_layout 
                        cols: 1 
                        spacing: "8dp"
                        size_hint_y: None
                        height: self.minimum_height
                        padding: 0
                        pos_hint: {'top': 1}

        # --- Bottom Controls --- #
        MDBoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.3
            spacing: "16dp"

            MDCard:
                size_hint_y: None
                height: "60dp"
                md_bg_color: get_color_from_hex('#2A2A2A')
                radius: [12]
                padding: "16dp"
                
                MDButton:
                    style: "elevated"
                    size_hint_x: None
                    width: "200dp"
                    pos_hint: {'center_x': .5, 'center_y': .5}
                    md_bg_color: get_color_from_hex('#4CAF50')
                    elevation: 3
                    on_press: 
                        self.md_bg_color = get_color_from_hex('#45a049')
                    on_release:
                        self.md_bg_color = get_color_from_hex('#4CAF50')
                        app.show_add_category_popup()
                    MDButtonIcon:
                        icon: "plus" 
                    MDButtonText:
                        text: "NUEVA CATEGORÍA"

            MDBoxLayout:
                orientation: 'horizontal'
                spacing: "16dp"
                
                MDCard:
                    elevation: 2
                    radius: [12]
                    md_bg_color: get_color_from_hex('#2A2A2A')
                    padding: "16dp"
                
                    MDBoxLayout:
                        orientation: 'vertical'
                        spacing: "8dp"
                        
                        MDBoxLayout:
                            size_hint_y: None
                            height: "40dp"
                            
                            MDIcon:
                                icon: "cash-multiple"
                                theme_text_color: "Custom"
                                text_color: get_color_from_hex('#4CAF50')
                                size_hint_x: None
                                width: "24dp"
                                
                            MDLabel:
                                text: "INGRESO (€)"
                                theme_text_color: "Custom"
                                text_color: get_color_from_hex('#FFFFFF')
                                bold: True
                                font_size: "18sp"
                
                        MDTextField:
                            id: income_input
                            hint_text: "Cantidad a distribuir"
                            text: "100"
                            input_filter: "float"
                            helper_text: "¡Listo para distribuir!"
                            helper_text_mode: "on_focus"
                            icon_right: "currency-eur"
                            icon_right_color: get_color_from_hex('#4CAF50')
                            line_color_normal: get_color_from_hex('#4CAF50')
                            line_color_focus: get_color_from_hex('#4CAF50')
                
                MDCard:
                    elevation: 2
                    radius: [12]
                    md_bg_color: get_color_from_hex('#2A2A2A')
                    padding: "16dp"
                    
                    MDButton:
                        style: "elevated"
                        size_hint: None, None
                        size: "200dp", "50dp"
                        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                        md_bg_color: get_color_from_hex('#4CAF50')
                        elevation: 3
                        on_press: 
                            self.md_bg_color = get_color_from_hex('#45a049')
                        on_release:
                            self.md_bg_color = get_color_from_hex('#4CAF50')
                            app.ui_distribute_income_kivy(income_input.text)
                        MDButtonIcon:
                            icon: "rocket-launch-outline" 
                        MDButtonText:
                            text: "DISTRIBUIR"

        # --- Log Display Area --- #
        AnchorLayout: 
            anchor_x: 'center'
            anchor_y: 'bottom'
            size_hint_y: 0.2
            padding: "16dp"
            
            MDCard:
                elevation: 2
                radius: [12]
                md_bg_color: get_color_from_hex('#1A1A1A')
                padding: "12dp"
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: "4dp"
                    
                    MDBoxLayout:
                        size_hint_y: None
                        height: "40dp"
                        padding: ["8dp", "0dp", "8dp", "0dp"]
                        md_bg_color: get_color_from_hex('#2A2A2A')
                        radius: [8]
                        
                        MDIcon:
                            icon: "console"
                            theme_text_color: "Custom"
                            text_color: get_color_from_hex('#4CAF50')
                            size_hint_x: None
                            width: "24dp"
                            
                        MDLabel:
                            text: "CONSOLA DE ACTIVIDAD"
                            theme_text_color: "Custom"
                            text_color: get_color_from_hex('#FFFFFF')
                            bold: True
                            font_size: "18sp"
                            halign: 'center'
                    
                    ScrollView:
                        id: log_scroll
                        do_scroll_x: False
                        bar_width: 5
                        bar_color: get_color_from_hex('#4CAF50')
                        bar_inactive_color: get_color_from_hex('#333333')
                        effect_cls: "ScrollEffect"
                        scroll_type: ['bars']
                        
                        MDLabel:
                            id: log_label
                            text: ""
                            markup: True
                            size_hint_y: None
                            height: self.texture_size[1]
                            font_name: "RobotoMono-Regular"
                            font_size: "12sp"
                            padding: "8dp", "8dp"

<AddCategoryPopup>:
    title: "Añadir Nueva Categoría"
    size_hint: 0.8, 0.4
    auto_dismiss: False
    background_color: get_color_from_hex('#1E1E1E')
    title_color: get_color_from_hex('#FFFFFF')
    separator_color: get_color_from_hex('#4CAF50')
    
    BoxLayout:
        orientation: 'vertical'
        padding: "16dp"
        spacing: "16dp"
        
        MDTextField:
            id: category_name_input
            helper_text_mode: "on_focus"
            MDTextFieldHintText:
                text: "Nombre de la categoría"
                text_color_normal: 1, 1, 1, 1
            MDTextFieldHelperText:
                text: "Introduce un nombre único"
                text_color_normal: 1, 1, 1, 0.7
            
        MDTextField:
            id: category_percentage_input
            helper_text_mode: "on_focus"
            input_filter: "float"
            MDTextFieldHintText:
                text: "Porcentaje (%)"
                text_color_normal: 1, 1, 1, 1
            MDTextFieldHelperText:
                text: "Valor entre 0 y 100"
                text_color_normal: 1, 1, 1, 0.7
            
        BoxLayout:
            orientation: 'horizontal'
            spacing: "16dp"
            size_hint_y: None
            height: "56dp"
            
            MDButton:
                style: "filled"
                on_release: root.dismiss()
                MDButtonText:
                    text: "Cancelar"
                
            MDButton:
                style: "filled"
                on_release: 
                    app.add_category_from_popup(root, category_name_input.text, category_percentage_input.text)
                MDButtonText:
                    text: "Guardar"

<EditCategoryPopup>:
    title: "Editar Categoría"
    size_hint: 0.8, 0.4
    auto_dismiss: False
    background_color: get_color_from_hex('#1E1E1E')
    title_color: get_color_from_hex('#FFFFFF')
    separator_color: get_color_from_hex('#4CAF50')
    category_id: None
    
    BoxLayout:
        orientation: 'vertical'
        padding: "16dp"
        spacing: "16dp"
        
        MDTextField:
            id: edit_category_name_input
            hint_text: "Nombre de la categoría"
            helper_text: "Introduce un nombre único"
            helper_text_mode: "on_focus"
            
        MDTextField:
            id: edit_category_percentage_input
            hint_text: "Porcentaje (%)"
            helper_text: "Valor entre 0 y 100"
            helper_text_mode: "on_focus"
            input_filter: "float"
            
        BoxLayout:
            orientation: 'horizontal'
            spacing: "16dp"
            size_hint_y: None
            height: "56dp"
            
            MDButton:
                style: "filled"
                on_release: root.dismiss()
                MDButtonText:
                    text: "Cancelar"
                
            MDButton:
                style: "filled"
                on_release: 
                    app.update_category_from_popup(root, str(root.category_id), edit_category_name_input.text, edit_category_percentage_input.text)
                MDButtonText:
                    text: "Guardar Cambios"
